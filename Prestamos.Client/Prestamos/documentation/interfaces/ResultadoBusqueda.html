<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>prestamos documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>

        <div class="navbar navbar-default navbar-fixed-top visible-xs">
            <a href="../" class="navbar-brand">prestamos documentation</a>
            <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="hidden-xs menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">













<ol class="breadcrumb">
  <li>Interfaces</li>
  <li
  >
  ResultadoBusqueda</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="active">
            <a href="#info" role="tab" id="info-tab" data-toggle="tab" data-link="info">Info</a>
        </li>
        <li >
            <a href="#source" role="tab" id="source-tab" data-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="c-info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/app/modules/admin/crear-prestamos/pages/conceder-prestamo/conceder-prestamo.component.ts</code>
        </p>




        <section>
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#message" 
>
                                            message
                                        </a>
                                </li>
                                <li>
                                        <a href="#succeeded" 
>
                                            succeeded
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section>
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="message"></a>
                                        <span class="name "><b>message</b>
                                            <a href="#message">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>message:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="succeeded"></a>
                                        <span class="name "><b>succeeded</b>
                                            <a href="#succeeded">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>succeeded:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/boolean" target="_blank" >boolean</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="c-source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import { Component, OnInit } from &#x27;@angular/core&#x27;;
import { FormBuilder, FormGroup, Validators } from &#x27;@angular/forms&#x27;;
import { Router } from &#x27;@angular/router&#x27;;
import { Cliente } from &#x27;src/app/Core/models/clientes/cliente.model&#x27;;
import { EstatuCrediticioCliente, EstatusPrestamosClientes, PeriodoDePagos } from &#x27;src/app/Core/models/Enums/enums.model&#x27;;
import { PeriodoPago } from &#x27;src/app/Core/models/periodosPagos/periodoPago.model&#x27;;
import { AddPrestamo } from &#x27;src/app/Core/models/prestamos/add-prestamo.model&#x27;;
import { AddDetallePrestamo } from &#x27;src/app/Core/models/prestamos/detallePrestamo/add-DetallePrestamo.model&#x27;;
import { ToastModel } from &#x27;src/app/Core/models/toasts/toast.model&#x27;;
import { UserAuth } from &#x27;src/app/Core/models/userAuth.model&#x27;;
import { AuthService } from &#x27;src/app/Shared/services/auth.service&#x27;;
import { ToastService } from &#x27;src/app/Shared/services/toast.service&#x27;;
import { ClienteService } from &#x27;../../../clientes/services/cliente.service&#x27;;
import { PeriodoPagoService } from &#x27;../../services/periodo-pago.service&#x27;;
import { PrestamoService } from &#x27;../../services/prestamo.service&#x27;;

interface ResultadoBusqueda {
  succeeded: boolean;
  message?: string;
}

@Component({
  selector: &#x27;app-conceder-prestamo&#x27;,
  templateUrl: &#x27;./conceder-prestamo.component.html&#x27;,
  styleUrls: [&#x27;./conceder-prestamo.component.scss&#x27;]
})
export class ConcederPrestamoComponent implements OnInit {
  showDialogo: boolean &#x3D; false;

  cliente!: Cliente;
  readonly columnas: string[] &#x3D; [&#x27;Nombre&#x27;, &#x27;Cedula&#x27;, &#x27;Telefono&#x27;, &#x27;Estatus Crediticio&#x27;];
  cedula: string &#x3D; &#x27;&#x27;;
  resultadoBusqueda!: ResultadoBusqueda;

  form: FormGroup &#x3D; new FormGroup({});
  periodoPagos!: PeriodoPago[];

  tablaAmortizacion!: any;
  columnasTablaAmortizacion &#x3D; [&#x27;Numero Cuota&#x27;, &#x27;Pago&#x27;, &#x27;Interes&#x27;, &#x27;Amortizacion&#x27;, &#x27;Pendiente&#x27;, &#x27;Fecha&#x27;];

  usuario!: UserAuth;
  constructor(private clienteSvc: ClienteService,
    private fb: FormBuilder,
    private periodoPagoSve: PeriodoPagoService,
    private authsvc: AuthService,
    private prestamoService: PrestamoService,
    private toast: ToastService,
    private router: Router) {
     this.createForm();
    }

  ngOnInit(): void {
    this.getPeriodosPrestamos();
    this.getUsuario();
  }

  private getPeriodosPrestamos(){
    this.periodoPagoSve.getPeriodosDePagos().subscribe(res &#x3D;&gt; {
      this.periodoPagos &#x3D; res.data;
    });
  }

  private getUsuario(){
    this.authsvc.getUserAuth().subscribe(res &#x3D;&gt; {
      this.usuario &#x3D; res;
    });
  }


  private createForm(){
    this.form &#x3D; this.fb.group({
      interes: [null, [Validators.required, Validators.min(1), Validators.max(100)]],
      capital: [null, [Validators.required, Validators.min(1)]],
      cuotas: [null, [Validators.required, Validators.min(1)]],
      periodoPago: [null, [Validators.required]],
    });
  }

  isInvalid(campo: string){
    return this.form.get(campo)!.invalid &amp;&amp; (this.form.get(campo)!.dirty || this.form.get(campo)!.touched);
  }

  buscarCliente(){
    this.cliente &#x3D; null!;
    if(this.cedula.length &gt; 0){
      this.clienteSvc.getClienteByCedula(this.cedula.trim()).subscribe(res &#x3D;&gt; {
        this.cliente &#x3D; res.data;
        this.resultadoBusqueda &#x3D; {
          succeeded: true,
        }
      }, error &#x3D;&gt; {
        this.resultadoBusqueda &#x3D; {
          succeeded: false,
          message: error.error.message
        }
      })
    }
  }

  calcularTabla(){
    const cuotas &#x3D; this.form.value.cuotas;
    const interes &#x3D; this.form.value.interes;
    const periodoPago &#x3D; this.form.value.periodoPago
    const capital &#x3D; this.form.value.capital
    let tabla &#x3D; [{
      numeroCuota: 0,
      pago: 0,
      interes: 0,
      amortizacion: 0,
      saldo: capital,
      idEstatusPrestamo: EstatusPrestamosClientes.Pagado,
      fecha: new Date()
    }];

    for(let i &#x3D;1; i &lt;&#x3D; cuotas; i++){
      const pagoTable &#x3D; this.getCuota(interes, capital, cuotas);
      const interesTabla &#x3D; this.redondear(( tabla[i-1].saldo * ((interes / 100))));
      const amortizacionTabla &#x3D; this.redondear((pagoTable - interesTabla));
      const saldoTabla &#x3D; this.redondear(( tabla[i-1].saldo -  amortizacionTabla));
      tabla &#x3D; [...tabla, {
        numeroCuota: i,
        pago: this.getCuota(interes, capital, cuotas),
        interes: interesTabla,
        amortizacion: amortizacionTabla,
        saldo: saldoTabla,
        idEstatusPrestamo: EstatusPrestamosClientes.Pendiente, 
        fecha: this.addDaysToDate(tabla[i-1].fecha, this.getDias(periodoPago))
      }]
    }
    tabla[tabla.length-1].saldo &#x3D; 0;
    this.tablaAmortizacion &#x3D; tabla;
  }

  private getFecha(periodoPago: PeriodoDePagos, fechaInicio: Date, cuotas: number): Date  {
    const dias &#x3D; periodoPago &#x3D;&#x3D;&#x3D; PeriodoDePagos.Diario ? cuotas :
                 periodoPago &#x3D;&#x3D;&#x3D; PeriodoDePagos.Semanal ? cuotas * 7 : 
                 periodoPago &#x3D;&#x3D;&#x3D; PeriodoDePagos.Quincenal ? cuotas * 15 :
                 periodoPago &#x3D;&#x3D;&#x3D; PeriodoDePagos.Mensual ? cuotas * 30 : cuotas * 365;
    return this.addDaysToDate(fechaInicio, dias);
  }

  private getDias(periodoPago: PeriodoDePagos): number {
    return periodoPago &#x3D;&#x3D;&#x3D; PeriodoDePagos.Diario ? 1 :
           periodoPago &#x3D;&#x3D;&#x3D; PeriodoDePagos.Semanal ? 7 : 
           periodoPago &#x3D;&#x3D;&#x3D; PeriodoDePagos.Quincenal ? 15 :
           periodoPago &#x3D;&#x3D;&#x3D; PeriodoDePagos.Mensual ? 30 : 365;
  }

  private addDaysToDate(date: Date, days: number): Date {
    var res &#x3D; new Date(date);
    res.setDate(res.getDate() + days);
    return res;
  }

  private getCuota(interes: number, capital: number, cuotas: number): number {
    let resultado &#x3D;  capital * (((interes / 100)) / (1 - Math.pow((1 + ((interes / 100))), - cuotas)));
    return this.redondear(resultado);
  }

  private redondear(numero: number): number {
    return Number(numero.toFixed(3));
  }

  limpiarTabla(){
    this.cliente &#x3D; null!;
    this.tablaAmortizacion &#x3D; null!;
    this.cedula &#x3D; null!;
    this.form.reset();
  }

  confirmarPrestamo(){
    this.showOrHideDialog();
  }


  onConfirmacion(event: boolean){
    if(event){
      if(this.comprobarSiElClientePuedeRealizarPrestamo(this.cliente.estatusCrediticio.estatusCrediticios)){
        this.guardarPrestamo();
        this.showOrHideDialog();
      }else{
        this.showToast({
          title: &#x27;El cliente no puede realizar prestamos porque tiene un prestamo pendiente&#x27;,
          body: &#x27;&#x27;,
          tipo: &#x27;error&#x27;
        });
      }
    }else{
       this.showOrHideDialog();
    }
    
  }

  private guardarPrestamo(){
    let detallePrestamo: AddDetallePrestamo[] &#x3D; this.tablaAmortizacion.map((item:any) &#x3D;&gt; {
      return {
        numeroCuota: item.numeroCuota,
        cuotaPagar: item.pago,
        interesPagar: item.interes,
        capitalAmortizado: item.amortizacion,
        pagado: 0,
        capitalPendiente: item.saldo,
        fechaPago: item.fecha,
        idEstatusPrestamo: item.idEstatusPrestamo
      }
    })
    
    const prestamo: AddPrestamo &#x3D; {
      interes: (this.form.value.interes / 100),
      cuotas: this.form.value.cuotas,
      capital: this.form.value.capital,
      idPeriodoPago: Number(this.periodoPagos.find(p &#x3D;&gt; p.periodoDePagos &#x3D;&#x3D;&#x3D; this.form.value.periodoPago)?.id),
      fechaCreado: new Date(),
      fechaCulminacion: this.getFecha(this.form.value.periodoPago, new Date(), this.form.value.cuotas),
      idUsuarioUtorizador: this.usuario.id,
      idCliente: this.cliente.id,
      detallePrestamos: detallePrestamo,
    }

    this.prestamoService.addPrestamo(prestamo).subscribe(res &#x3D;&gt; {
      this.showToast({
        title: &#x27;Prestamo&#x27;,
        body: &#x27;Prestamo registrado correctamente&#x27;,
        tipo: &#x27;success&#x27;
      }, () &#x3D;&gt; {
        this.router.navigate([&#x27;admin/crear-prestamos/factura&#x27;,res.data.id]);
      });
      this.limpiarTabla();
    }, error &#x3D;&gt; {
      this.showToast({
        title: &#x27;Eror&#x27;,
        body: &#x27;Ocurio un error&#x27;,
        tipo: &#x27;error&#x27;
      });
    })
  }

  showToast(toast: ToastModel, fn?: () &#x3D;&gt; void){
    this.toast.show(toast)
    setTimeout(() &#x3D;&gt; {
      fn!();
      this.toast.hide();
    }, 2000)
  }
  
  showOrHideDialog(){
    this.showDialogo &#x3D; !this.showDialogo;
  }

  private comprobarSiElClientePuedeRealizarPrestamo(estatus: EstatuCrediticioCliente){
    return estatus &#x3D;&#x3D;&#x3D; EstatuCrediticioCliente.Libre;
  }

}
</code></pre>
    </div>
</div>







                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'ResultadoBusqueda.html';
       </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>
       <script src="../js/libs/zepto.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
